# 分享广场功能实现说明

## 已完成的部分

### 1. 数据库迁移
- 文件：`end/db/migrate-share.js`
- 功能：为 `files` 表添加 `is_shared`（是否分享）和 `shared_at`（分享时间）字段
- 执行方式：运行 `node end/db/migrate-share.js`

### 2. 后端 API
- 文件：`end/routes/share.js`
- 已实现的接口：
  - `POST /api/share/files/:id` - 分享文件到广场
  - `DELETE /api/share/files/:id` - 取消分享文件
  - `GET /api/share/square` - 获取分享广场文件列表（支持分页和类型筛选）
  - `POST /api/share/save/:id` - 保存分享文件到我的网盘

### 3. 前端 API 封装
- 文件：`front/src/api/index.js`
- 已添加 `shareApi` 对象，包含所有分享相关的 API 调用方法

### 4. 前端页面修改
- 文件：`front/src/views/Home.vue`
- 已完成：
  - 添加"分享广场"侧边栏菜单项
  - 添加分享广场相关状态变量
  - 修改 `tableData` 计算属性，支持显示分享广场文件
  - 修改 `handleMenuSelect` 函数，切换到分享广场时加载数据
  - 添加分享相关函数：
    - `handleShare()` - 分享文件到广场
    - `handleUnshare()` - 取消分享
    - `loadSharedFiles()` - 加载分享广场文件
    - `handleSaveSharedFile()` - 保存分享文件到我的网盘
    - `handleCopyLink()` - 复制文件链接

## 需要手动完成的部分

### 1. 修改卡片视图的操作按钮

在 `Home.vue` 文件中找到卡片操作按钮部分（约 337-368 行），将"分享"按钮修改为：

```vue
<!-- 在分享广场中显示"保存"按钮，否则显示"分享"按钮 -->
<el-button v-if="activeMenu === 'share-square' && item.type !== 'folder'" 
    circle size="small" type="success"
    @click.stop="handleSaveSharedFile(item)">
    <el-icon>
        <Download />
    </el-icon>
</el-button>
<el-button v-else-if="item.type !== 'folder'" 
    circle size="small" type="warning"
    @click.stop="handleShare(item)">
    <el-icon>
        <Share />
    </el-icon>
</el-button>

<!-- 添加复制链接按钮 -->
<el-button v-if="item.type !== 'folder'" 
    circle size="small" type="info"
    @click.stop="handleCopyLink(item)">
    <el-icon>
        <Link />
    </el-icon>
</el-button>
```

### 2. 修改列表视图的操作列

在列表视图的操作列中（约 200-240 行），添加类似的条件判断：

```vue
<el-table-column label="操作" width="200" fixed="right">
    <template #default="{ row }">
        <!-- 分享广场中的操作 -->
        <template v-if="activeMenu === 'share-square'">
            <el-button type="success" size="small" @click="handleSaveSharedFile(row)">
                保存到网盘
            </el-button>
            <el-button type="primary" size="small" @click="handlePreview(row)" v-if="canPreview(row)">
                预览
            </el-button>
            <el-button type="info" size="small" @click="handleCopyLink(row)">
                复制链接
            </el-button>
        </template>
        
        <!-- 我的文件中的操作 -->
        <template v-else>
            <!-- 原有的操作按钮 -->
            <el-button v-if="row.type === 'folder'" type="primary" size="small"  
                @click="handleRenameFolder(row)">
                重命名
            </el-button>
            <el-button type="danger" size="small" @click="handleDelete(row)">
                删除
            </el-button>
            <el-button v-if="row.type !== 'folder'" type="warning" size="small" 
                @click="handleShare(row)">
                分享
            </el-button>
            <el-button v-if="row.type !== 'folder'" type="info" size="small" 
                @click="handleCopyLink(row)">
                复制链接
            </el-button>
            <!-- 其他原有按钮 -->
        </template>
    </template>
</el-table-column>
```

### 3. 启动后端服务

1. 首先执行数据库迁移：
```bash
cd end
node db/migrate-share.js
```

2. 启动后端服务器：
```bash
cd end
npm run dev
```

### 4. 测试功能

1. 在"全部文件"中选择一个文件，点击"分享"按钮
2. 切换到"分享广场"菜单，应该能看到刚才分享的文件
3. 在分享广场中点击"保存到网盘"按钮
4. 返回"全部文件"，应该能看到保存的文件

## 功能特点

1. **分享机制**：文件分享后会在分享广场显示，但文件本身仍在 OSS 中，不会重复上传
2. **保存机制**：保存分享文件只是在数据库中创建一条新记录，指向同一个 OSS 文件
3. **权限控制**：分享广场中的文件只能预览和保存，不能删除或修改
4. **分页支持**：分享广场支持分页和类型筛选
5. **时间显示**：显示文件的分享时间

## 注意事项

- 分享广场中不显示文件夹，只显示文件
- 分享的文件在原位置删除后，分享状态会保留（如需同步删除，需要修改删除逻辑）
- 保存的文件会默认保存到当前所在的文件夹
