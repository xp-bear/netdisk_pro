# 存储空间管理功能说明

## 功能概述
实现了完整的用户存储空间管理功能，实时显示存储空间使用情况，并在文件上传、删除时自动更新存储空间使用量。

## 核心功能

### 1. 存储空间显示
- **主页头部**：用户下拉菜单中显示存储空间进度条
- **个人资料页面**：显示详细的存储空间信息
  - 已用空间 / 总空间
  - 彩色进度条（绿色/黄色/红色）
  - 百分比显示

### 2. 自动计算和更新
- **文件上传时**：自动增加存储使用量
- **文件删除时**：自动减少存储使用量
- **实时同步**：前端和后端数据实时同步

### 3. 数据库设计

#### users 表字段
```sql
storage_limit BIGINT DEFAULT 10737418240  -- 存储限制（默认10GB）
storage_used  BIGINT DEFAULT 0           -- 已使用空间（字节）
```

## 技术实现

### 后端实现（files.js）

#### 1. 创建文件时更新存储空间
```javascript
// 使用事务确保数据一致性
const connection = await pool.getConnection()
await connection.beginTransaction()

try {
  // 1. 插入文件记录
  await connection.query('INSERT INTO files ...')
  
  // 2. 更新用户存储使用量
  await connection.query(
    'UPDATE users SET storage_used = storage_used + ? WHERE id = ?',
    [fileSize, userId]
  )
  
  // 3. 提交事务
  await connection.commit()
  
  // 4. 返回更新后的存储信息
  return { ..., storage: { storage_used, storage_limit } }
} catch (error) {
  await connection.rollback()
  throw error
}
```

#### 2. 删除文件时更新存储空间
```javascript
// 使用事务确保数据一致性
const connection = await pool.getConnection()
await connection.beginTransaction()

try {
  // 1. 获取文件大小
  const [files] = await connection.query('SELECT size FROM files ...')
  
  // 2. 删除文件记录
  await connection.query('DELETE FROM files ...')
  
  // 3. 减少用户存储使用量（使用 GREATEST 防止负数）
  await connection.query(
    'UPDATE users SET storage_used = GREATEST(storage_used - ?, 0) WHERE id = ?',
    [fileSize, userId]
  )
  
  // 4. 提交事务
  await connection.commit()
  
  // 5. 返回更新后的存储信息
  return { ..., storage: { storage_used, storage_limit } }
} catch (error) {
  await connection.rollback()
  throw error
}
```

### 前端实现

#### 1. 用户状态管理（user.js）
```javascript
// 存储空间相关计算属性
const storageLimit = computed(() => user.value?.storage_limit || 0)
const storageUsed = computed(() => user.value?.storage_used || 0)
const storagePercent = computed(() => {
  if (storageLimit.value === 0) return 0
  return Math.round((storageUsed.value / storageLimit.value) * 100)
})

// 更新存储使用量
function updateStorageUsed(used) {
  if (user.value) {
    user.value.storage_used = used
    localStorage.setItem('user', JSON.stringify(user.value))
  }
}
```

#### 2. 文件操作更新（file.js）
```javascript
// 创建文件后更新
async function createFile(fileData) {
  const response = await fileApi.createFile(fileData)
  
  // 更新用户存储空间
  if (response.storage) {
    const userStore = useUserStore()
    userStore.updateStorageUsed(response.storage.storage_used)
  }
}

// 删除文件后更新
async function deleteFile(id) {
  const response = await fileApi.deleteFile(id)
  
  // 更新用户存储空间
  if (response.storage) {
    const userStore = useUserStore()
    userStore.updateStorageUsed(response.storage.storage_used)
  }
}
```

#### 3. 界面显示（Profile.vue & Home.vue）

**个人资料页面**：
```vue
<div class="storage-section">
  <div class="storage-header">
    <span class="storage-title">
      <el-icon><Folder /></el-icon>
      存储空间
    </span>
    <span class="storage-text">
      {{ formatSize(userStore.storageUsed) }} / {{ formatSize(userStore.storageLimit) }}
    </span>
  </div>
  <el-progress 
    :percentage="userStore.storagePercent" 
    :color="storageColor"
    :stroke-width="12"
  />
</div>
```

**主页下拉菜单**：
```vue
<el-dropdown-item disabled>
  <div class="storage-info">
    <p>存储空间</p>
    <el-progress :percentage="userStore.storagePercent" :color="getStorageColor()" />
    <p class="storage-text">
      {{ formatFileSize(userStore.storageUsed) }} / {{ formatFileSize(userStore.storageLimit) }}
    </p>
  </div>
</el-dropdown-item>
```

## 进度条颜色规则

```javascript
function storageColor() {
  const percent = userStore.storagePercent
  if (percent < 60) return '#67c23a'  // 绿色：充足
  if (percent < 80) return '#e6a23c'  // 黄色：警告
  return '#f56c6c'                    // 红色：接近满
}
```

## 文件大小格式化

```javascript
function formatSize(bytes) {
  if (bytes === 0) return '0 B'
  const k = 1024
  const sizes = ['B', 'KB', 'MB', 'GB', 'TB']
  const i = Math.floor(Math.log(bytes) / Math.log(k))
  return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i]
}
```

## 数据一致性保障

### 1. 使用数据库事务
- 确保文件操作和存储空间更新的原子性
- 失败自动回滚，保证数据一致性

### 2. 防止负数
```sql
UPDATE users SET storage_used = GREATEST(storage_used - ?, 0) WHERE id = ?
```
使用 `GREATEST` 函数确保存储使用量不会变成负数

### 3. 实时同步
- 每次文件操作后立即返回最新存储信息
- 前端接收后立即更新 store 和 localStorage
- 确保界面显示实时准确

## 默认配置

- **默认存储限制**：10GB (10737418240 字节)
- **初始使用量**：0 字节
- **可在数据库中为每个用户单独配置限制**

## 使用场景

### 1. 文件上传
1. 用户选择文件上传
2. 文件上传到 OSS
3. 保存文件记录到数据库
4. 自动增加 `storage_used`
5. 返回最新存储信息
6. 前端更新进度条显示

### 2. 文件删除
1. 用户删除文件
2. 从数据库获取文件大小
3. 删除文件记录
4. 自动减少 `storage_used`
5. 返回最新存储信息
6. 前端更新进度条显示

### 3. 实时查看
- 个人资料页面：完整显示存储空间详情
- 主页下拉菜单：快速查看存储情况
- 进度条颜色：直观显示使用状态

## 注意事项

1. **事务处理**：所有涉及存储空间更新的操作都使用事务
2. **错误处理**：失败时自动回滚，确保数据一致性
3. **并发控制**：数据库层面的原子操作，避免并发问题
4. **性能优化**：只在必要时查询和更新存储信息
5. **用户体验**：实时更新，无需刷新页面

## 后续优化建议

1. **存储配额管理**
   - 管理员可配置用户存储限制
   - 不同用户等级不同配额

2. **存储预警**
   - 接近限制时提醒用户
   - 超过限制时禁止上传

3. **存储统计**
   - 按文件类型统计使用量
   - 显示最占空间的文件

4. **回收站功能**
   - 删除文件不立即释放空间
   - 彻底删除后才释放

5. **存储清理**
   - 批量删除功能
   - 自动清理过期文件

6. **购买扩容**
   - 用户可购买额外空间
   - 会员特权更大配额
